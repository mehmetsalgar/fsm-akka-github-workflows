name: Cleanup - Pull Request Closing
run-name: ${{ github.actor }}
on:
  workflow_call:
    inputs:
      repo-name:
        required: true
        type: string
      branch-name:
        required: true
        type: string
jobs:
  cleanup-umbrella-chart:
    runs-on: ubuntu-latest
    steps:
      - name: Clean Umbrella Helm Chart
        uses: aurelien-baudet/workflow-dispatch@v2
        with:
          workflow: 'delete-branch.yaml'
          repo: 'mehmetsalgar/fsm-akka-helm-umbrella-chart'
          ref: 'master'
          token: ${{ secrets.PERSONAL_TOKEN }}
          wait-for-completion: true
          wait-for-completion-timeout: 10m
          wait-for-completion-interval: 30s
          inputs: '{"branch-name": "${{ inputs.branch-name }}-${{ inputs.repo-name }}"}'
  cleanup-dev-environment:
    runs-on: ubuntu-latest
    needs: cleanup-umbrella-chart
    steps:
      - name: Clean dev-environment
        uses: aurelien-baudet/workflow-dispatch@v2
        with:
          workflow: 'delete-branch.yaml'
          repo: 'mehmetsalgar/fsm-akka-dev-environment'
          ref: 'master'
          token: ${{ secrets.PERSONAL_TOKEN }}
          wait-for-completion: true
          wait-for-completion-timeout: 5m
          wait-for-completion-interval: 30s
          inputs: '{"branch-name": "${{ inputs.branch-name }}-${{ inputs.repo-name }}"}'
  remove-k8s-environment:
    runs-on: ubuntu-latest
    needs: cleanup-dev-environment
    steps:
      - name: Clean Infrastructure Environment in K8s
        uses: aurelien-baudet/workflow-dispatch@v2
        with:
          workflow: 'cleanup-infrastructure.yaml'
          repo: 'mehmetsalgar/fsm-akka-helm-infrastructure-chart'
          ref: 'master'
          token: ${{ secrets.PERSONAL_TOKEN }}
          wait-for-completion: true
          wait-for-completion-timeout: 5m
          wait-for-completion-interval: 30s
          inputs: '{"branch-name": "${{ inputs.branch-name }}-${{ inputs.repo-name }}"}'
      - name: Clean Environment in K8s
        uses: aurelien-baudet/workflow-dispatch@v2
        with:
          workflow: 'cleanup-environment.yaml'
          repo: 'mehmetsalgar/fsm-akka-4eyes-argocd'
          ref: 'master'
          token: ${{ secrets.PERSONAL_TOKEN }}
          wait-for-completion: true
          wait-for-completion-timeout: 5m
          wait-for-completion-interval: 30s
          inputs: '{"branch-name": "${{ inputs.branch-name }}-${{ inputs.repo-name }}"}'
